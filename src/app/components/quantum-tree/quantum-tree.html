<div class="quantum-container">
    <div class="quantum-header">
        <h2>Quantum Weaving</h2>
        <div class="quantum-stats">
            <div class="stat-item">
                <span class="stat-label">Quanta:</span>
                <span class="stat-value">{{ formatNumber(quantumService.quanta()) }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Per Second:</span>
                <span class="stat-value production">+{{ formatNumber(quantumService.quantaPerSecond()) }}/s</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Total Generated:</span>
                <span class="stat-value">{{ formatNumber(quantumService.totalQuantaGenerated()) }}</span>
            </div>
        </div>
        @if (!artifactService.systemUnlocked()) {
        <div class="artifact-unlock-progress">
            <div class="progress-label">
                <span>ðŸ”¬ Artifact System Progress: {{formatNumber(quantumService.totalQuantaGenerated())}} / 50.00M Quanta</span>
                <span class="progress-percent">{{getArtifactUnlockProgress()}}%</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" [style.width.%]="getArtifactUnlockProgress()"></div>
            </div>
        </div>
        }
    </div>
    <div class="help-panel">
        <h3>âš› How Quantum Weaving Works</h3>
        <div class="help-grid">
            <div class="help-item">
                <div class="help-icon">ðŸ”·</div>
                <div class="help-content">
                    <strong>Quantum Nodes</strong>
                    <p>Upgrade nodes with Quanta to increase production. Each tree (Matter, Energy, Time) has unique
                        bonuses.</p>
                </div>
            </div>
            <div class="help-item">
                <div class="help-icon">âœ¨</div>
                <div class="help-content">
                    <strong>Synergies</strong>
                    <p>Unlock specific node combinations to activate passive synergies that boost your production
                        multipliers.</p>
                </div>
            </div>
            <div class="help-item">
                <div class="help-icon">ðŸ”“</div>
                <div class="help-content">
                    <strong>Unlocking Nodes</strong>
                    <p>Higher tier nodes unlock when you reach required Quanta generation and upgrade prerequisite
                        nodes.</p>
                </div>
            </div>
            <div class="help-item">
                <div class="help-icon">ï¿½</div>
                <div class="help-content">
                    <strong>Production Types</strong>
                    <p>Production nodes add flat Quanta/sec, while Multiplier nodes multiply your total production.</p>
                </div>
            </div>
        </div>
    </div>
    @if (activeSynergies().length > 0) {
    <div class="synergies-panel">
        <h3>Active Synergies</h3>
        <div class="synergies-list">
            @for (synergy of activeSynergies(); track synergy.id) {
            <div class="synergy-card">
                <span class="synergy-icon">{{ synergy.icon }}</span>
                <div class="synergy-content">
                    <div class="synergy-name">{{ synergy.name }}</div>
                    <div class="synergy-effect">{{ synergy.effect.description }}</div>
                </div>
            </div>
            }
        </div>
    </div>
    }
    <div class="trees-container">
        <div class="tree-column matter">
            <h3 class="tree-title">{{ getTreeTitle(QuantumTreeType.MATTER) }}</h3>
            <div class="tree-grid">
                @for (node of matterNodes(); track node.id) {
                @if (getNodeState(node.id); as state) {
                <div [class]="getNodeClasses(node).join(' ')" [style.grid-column]="node.position.x + 1"
                    [style.grid-row]="node.position.y + 1">
                    @if (isNodeInAnySynergy(node.id)) {
                    <div class="synergy-indicator" [class.active]="isNodeInActiveSynergy(node.id)">âœ¨</div>
                    }
                    <div class="node-icon">{{ node.icon }}</div>
                    <div class="node-name">{{ node.name }}</div>
                    <div class="node-level">Lv {{ state.level }}/{{ node.maxLevel }}</div>
                    @if (getSynergiesForNode(node.id).length > 0) {
                    <div class="node-synergies">
                        @for (synergy of getSynergiesForNode(node.id); track synergy.id) {
                        <div class="synergy-hint" [class.unlocked]="isNodeInActiveSynergy(node.id)">
                            {{ synergy.icon }} {{ synergy.name }}
                        </div>
                        }
                    </div>
                    }
                    @if (state.unlocked) {
                    <div class="node-effect">
                        @if (node.productionBonus) {
                        <span>+{{ node.productionBonus * state.level }}/s</span>
                        }
                        @if (node.multiplierBonus) {
                        <span>Ã—{{ roundMultiplier(1 + (node.multiplierBonus * state.level)) }}</span>
                        }
                    </div>
                    @if (state.level < node.maxLevel) { <button class="upgrade-btn" [disabled]="!canUpgrade(node.id)"
                        (click)="upgradeNode(node.id); $event.stopPropagation()">
                        {{ formatNumber(getNodeCost(node.id)) }}
                        </button>
                        } @else {
                        <div class="max-badge">MAX</div>
                        }
                        } @else {
                        <div class="locked-badge">ðŸ”’</div>
                        }
                </div>
                }
                }
            </div>
        </div>
        <div class="tree-column energy">
            <h3 class="tree-title">{{ getTreeTitle(QuantumTreeType.ENERGY) }}</h3>
            <div class="tree-grid">
                @for (node of energyNodes(); track node.id) {
                @if (getNodeState(node.id); as state) {
                <div [class]="getNodeClasses(node).join(' ')" [style.grid-column]="node.position.x + 1"
                    [style.grid-row]="node.position.y + 1">
                    @if (isNodeInAnySynergy(node.id)) {
                    <div class="synergy-indicator" [class.active]="isNodeInActiveSynergy(node.id)">âœ¨</div>
                    }
                    <div class="node-icon">{{ node.icon }}</div>
                    <div class="node-name">{{ node.name }}</div>
                    <div class="node-level">Lv {{ state.level }}/{{ node.maxLevel }}</div>
                    @if (getSynergiesForNode(node.id).length > 0) {
                    <div class="node-synergies">
                        @for (synergy of getSynergiesForNode(node.id); track synergy.id) {
                        <div class="synergy-hint" [class.unlocked]="isNodeInActiveSynergy(node.id)">
                            {{ synergy.icon }} {{ synergy.name }}
                        </div>
                        }
                    </div>
                    }
                    @if (state.unlocked) {
                    <div class="node-effect">
                        @if (node.productionBonus) {
                        <span>+{{ node.productionBonus * state.level }}/s</span>
                        }
                        @if (node.multiplierBonus) {
                        <span>Ã—{{ roundMultiplier(1 + (node.multiplierBonus * state.level)) }}</span>
                        }
                    </div>
                    @if (state.level < node.maxLevel) { <button class="upgrade-btn" [disabled]="!canUpgrade(node.id)"
                        (click)="upgradeNode(node.id); $event.stopPropagation()">
                        {{ formatNumber(getNodeCost(node.id)) }}
                        </button>
                        } @else {
                        <div class="max-badge">MAX</div>
                        }
                        } @else {
                        <div class="locked-badge">ðŸ”’</div>
                        }
                </div>
                }
                }
            </div>
        </div>
        <div class="tree-column time">
            <h3 class="tree-title">{{ getTreeTitle(QuantumTreeType.TIME) }}</h3>
            <div class="tree-grid">
                @for (node of timeNodes(); track node.id) {
                @if (getNodeState(node.id); as state) {
                <div [class]="getNodeClasses(node).join(' ')" [style.grid-column]="node.position.x + 1"
                    [style.grid-row]="node.position.y + 1">
                    @if (isNodeInAnySynergy(node.id)) {
                    <div class="synergy-indicator" [class.active]="isNodeInActiveSynergy(node.id)">âœ¨</div>
                    }
                    <div class="node-icon">{{ node.icon }}</div>
                    <div class="node-name">{{ node.name }}</div>
                    <div class="node-level">Lv {{ state.level }}/{{ node.maxLevel }}</div>
                    @if (getSynergiesForNode(node.id).length > 0) {
                    <div class="node-synergies">
                        @for (synergy of getSynergiesForNode(node.id); track synergy.id) {
                        <div class="synergy-hint" [class.unlocked]="isNodeInActiveSynergy(node.id)">
                            {{ synergy.icon }} {{ synergy.name }}
                        </div>
                        }
                    </div>
                    }
                    @if (state.unlocked) {
                    <div class="node-effect">
                        @if (node.productionBonus) {
                        <span>+{{ node.productionBonus * state.level }}/s</span>
                        }
                        @if (node.multiplierBonus) {
                        <span>Ã—{{ roundMultiplier(1 + (node.multiplierBonus * state.level)) }}</span>
                        }
                    </div>
                    @if (state.level < node.maxLevel) { <button class="upgrade-btn" [disabled]="!canUpgrade(node.id)"
                        (click)="upgradeNode(node.id); $event.stopPropagation()">
                        {{ formatNumber(getNodeCost(node.id)) }}
                        </button>
                        } @else {
                        <div class="max-badge">MAX</div>
                        }
                        } @else {
                        <div class="locked-badge">ðŸ”’</div>
                        }
                </div>
                }
                }
            </div>
        </div>
    </div>
    <div class="legend">
        <div class="legend-item">
            <div class="legend-icon type-production"></div>
            <span>Production</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon type-multiplier"></div>
            <span>Multiplier</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon type-synergy"></div>
            <span>Synergy</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon type-special"></div>
            <span>Special</span>
        </div>
    </div>
</div>